# BEGA L2 Alert Rules - Optimized for Production
# ì‹¤ì œ ìš´ì˜ í™˜ê²½ì— ë§ê²Œ ìµœì í™”ëœ ì•Œë¦¼ ê·œì¹™

groups:
  - name: bega_l2_critical
    interval: 30s
    rules:
      # ========================================
      # Critical: Batcher ETH Balance Low
      # ========================================
      # Batcher ì§€ê°‘ì˜ ETH ì”ê³ ê°€ ë¶€ì¡±í•˜ë©´ L1ì— ë°°ì¹˜ë¥¼ ì œì¶œí•  ìˆ˜ ì—†ìŒ
      # Sepolia ê¸°ì¤€: 0.05 ETH, Mainnet ê¸°ì¤€: 0.5 ETH ê¶Œì¥
      - alert: BatcherLowETH
        expr: op_batcher_default_balance < 0.05
        for: 5m
        labels:
          severity: critical
          component: batcher
        annotations:
          summary: "ğŸš¨ Batcher ETH ì”ê³  ë¶€ì¡±"
          description: "Batcher ì§€ê°‘ ì”ê³ ê°€ {{ $value }} ETHë¡œ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì¶©ì „ì´ í•„ìš”í•©ë‹ˆë‹¤. (ê¶Œì¥: 0.1 ETH ì´ìƒ)"

      # ========================================
      # Critical: Batcher Very Low ETH (Warning before Critical)
      # ========================================
      - alert: BatcherVeryLowETH
        expr: op_batcher_default_balance < 0.1
        for: 10m
        labels:
          severity: warning
          component: batcher
        annotations:
          summary: "âš ï¸ Batcher ETH ì”ê³  ê²½ê³ "
          description: "Batcher ì§€ê°‘ ì”ê³ ê°€ {{ $value }} ETHì…ë‹ˆë‹¤. ê³§ ì¶©ì „ì´ í•„ìš”í•©ë‹ˆë‹¤."

      # ========================================
      # Critical: L2 Geth Node Down
      # ========================================
      - alert: L2GethDown
        expr: up{job="l2-geth"} == 0
        for: 1m
        labels:
          severity: critical
          component: l2-geth
        annotations:
          summary: "ğŸš¨ L2 Geth ë…¸ë“œ ë‹¤ìš´"
          description: "L2 Geth ì‹¤í–‰ ë ˆì´ì–´ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ íŠ¸ëœì­ì…˜ì„ ì œì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

      # ========================================
      # Critical: L2 Rollup Node Down
      # ========================================
      - alert: L2NodeDown
        expr: up{job="l2-node"} == 0
        for: 1m
        labels:
          severity: critical
          component: l2-node
        annotations:
          summary: "ğŸš¨ L2 Rollup ë…¸ë“œ ë‹¤ìš´"
          description: "L2 í•©ì˜/ë¡¤ì—… ë…¸ë“œê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì²´ì¸ì´ ìƒˆë¡œìš´ L2 ë¸”ë¡ì„ ìƒì„±í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

      # ========================================
      # Critical: Batcher Service Down
      # ========================================
      - alert: BatcherDown
        expr: up{job="l2-batcher"} == 0
        for: 1m
        labels:
          severity: critical
          component: l2-batcher
        annotations:
          summary: "ğŸš¨ Batcher ì„œë¹„ìŠ¤ ë‹¤ìš´"
          description: "Batcherê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤. L2 íŠ¸ëœì­ì…˜ì´ L1ì— ê²Œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

      # ========================================
      # Critical: Batcher Transaction Pending Too Long
      # ========================================
      # Batcherê°€ íŠ¸ëœì­ì…˜ì„ ì œì¶œí–ˆì§€ë§Œ 10ë¶„ ì´ìƒ pending ìƒíƒœ
      - alert: BatcherTxStuck
        expr: op_batcher_default_txmgr_pending_txs > 0
        for: 10m
        labels:
          severity: critical
          component: batcher
        annotations:
          summary: "ğŸš¨ Batcher íŠ¸ëœì­ì…˜ ì§€ì—°"
          description: "Batcherì— {{ $value }}ê°œì˜ pending íŠ¸ëœì­ì…˜ì´ 10ë¶„ ì´ìƒ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. L1 ê°€ìŠ¤ë¹„ë¥¼ í™•ì¸í•˜ì„¸ìš”."

  - name: bega_l2_warning
    interval: 60s
    rules:
      # ========================================
      # Warning: High L1 Gas Price
      # ========================================
      # Sepolia ê¸°ì¤€: 20 gwei, Mainnet ê¸°ì¤€: 50-100 gwei
      - alert: HighL1GasPrice
        expr: op_batcher_default_txmgr_basefee_wei / 1e9 > 20
        for: 10m
        labels:
          severity: warning
          component: batcher
        annotations:
          summary: "âš ï¸ L1 ê°€ìŠ¤ë¹„ ë†’ìŒ"
          description: "L1 ê°€ìŠ¤ë¹„ê°€ {{ $value }} gweië¡œ ë†’ìŠµë‹ˆë‹¤. ë°°ì¹˜ ì œì¶œ ë¹„ìš©ì´ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤."

      # ========================================
      # Warning: L2 Block Production Slow
      # ========================================
      # BEGA L2ëŠ” 2ì´ˆë§ˆë‹¤ ë¸”ë¡ ìƒì„± ì˜ˆìƒ (0.5 blocks/sec)
      - alert: L2BlockProductionSlow
        expr: rate(eth_block_number{job="l2-geth"}[5m]) < 0.3
        for: 5m
        labels:
          severity: warning
          component: l2-geth
        annotations:
          summary: "âš ï¸ L2 ë¸”ë¡ ìƒì„± ì†ë„ ì €í•˜"
          description: "L2ê°€ {{ $value | humanize }} blocks/sec ì†ë„ë¡œ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. (ì˜ˆìƒ: ~0.5 blocks/sec)"

      # ========================================
      # Warning: High Memory Usage
      # ========================================
      # 8GB ì´ìƒ ë©”ëª¨ë¦¬ ì‚¬ìš© ì‹œ ê²½ê³ 
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job=~"l2-geth|l2-node|l2-batcher"} > 8e9
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰"
          description: "{{ $labels.job }} í”„ë¡œì„¸ìŠ¤ê°€ {{ $value | humanize }}Bì˜ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤."

      # ========================================
      # Warning: Batcher Channel Queue High
      # ========================================
      # Batcherì˜ ì±„ë„ íê°€ ìŒ“ì´ë©´ ë°°ì¹˜ ì œì¶œì´ ì§€ì—°ë  ìˆ˜ ìˆìŒ
      - alert: BatcherChannelQueueHigh
        expr: op_batcher_default_channel_queue_length > 10
        for: 5m
        labels:
          severity: warning
          component: batcher
        annotations:
          summary: "âš ï¸ Batcher ì±„ë„ í ëˆ„ì "
          description: "Batcher ì±„ë„ íì— {{ $value }}ê°œì˜ ì±„ë„ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤."

      # ========================================
      # Warning: High CPU Usage
      # ========================================
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job=~"l2-geth|l2-node|l2-batcher"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ ë†’ì€ CPU ì‚¬ìš©ë¥ "
          description: "{{ $labels.job }} í”„ë¡œì„¸ìŠ¤ì˜ CPU ì‚¬ìš©ë¥ ì´ {{ $value | humanizePercentage }}ì…ë‹ˆë‹¤."

  - name: bega_l2_info
    interval: 120s
    rules:
      # ========================================
      # Info: Batcher Transaction Submitted
      # ========================================
      # ìµœê·¼ 30ë¶„ê°„ ë°°ì¹˜ ì œì¶œì´ ì—†ìœ¼ë©´ ì•Œë¦¼ (ì •ìƒ ë™ì‘ í™•ì¸ìš©)
      - alert: NoRecentBatchSubmission
        expr: (time() - op_batcher_default_last_batcher_tx_unix) > 1800
        for: 5m
        labels:
          severity: info
          component: batcher
        annotations:
          summary: "â„¹ï¸ ìµœê·¼ ë°°ì¹˜ ì œì¶œ ì—†ìŒ"
          description: "ìµœê·¼ 30ë¶„ê°„ Batcherê°€ ë°°ì¹˜ë¥¼ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì´ ì—†ê±°ë‚˜ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

      # ========================================
      # Info: Low Transaction Activity
      # ========================================
      # íŠ¸ëœì­ì…˜ í’€ì´ 1ì‹œê°„ ë™ì•ˆ ë¹„ì–´ìˆìœ¼ë©´ ì•Œë¦¼
      - alert: LowTransactionActivity
        expr: eth_txpool_pending{job="l2-geth"} == 0
        for: 1h
        labels:
          severity: info
          component: l2-geth
        annotations:
          summary: "â„¹ï¸ ë‚®ì€ íŠ¸ëœì­ì…˜ í™œë™"
          description: "1ì‹œê°„ ë™ì•ˆ pending íŠ¸ëœì­ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™œë™ì´ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤."

# ========================================
# ì£¼ì„: ì‹œí€€ì„œ ëª¨ë“œì—ì„œëŠ” í•„ìš” ì—†ëŠ” ì•Œë¦¼
# ========================================
# LowPeerCount - ì‹œí€€ì„œ ëª¨ë“œì—ì„œëŠ” P2P í”¼ì–´ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì œê±°ë¨
# í–¥í›„ ê²€ì¦ì ë…¸ë“œë¥¼ ì¶”ê°€í•  ê²½ìš° ì´ ì•Œë¦¼ì„ ë‹¤ì‹œ í™œì„±í™”í•  ê²ƒ
