version: '3.8'

# ============================================
# Shared Configuration: Log Rotation
# ============================================
# Prevents disk exhaustion from infinite Docker logs
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"  # Maximum size per log file
    max-file: "3"    # Keep 3 rotated files (total: 30MB per container)

services:
  # 1. Geth Initialization (runs once to create genesis block)
  l2-geth-init:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:${OP_GETH_TAG:-latest}
    command: >
      init --datadir=/db /config/genesis.json
    volumes:
      - ./data:/db
      - ./config:/config
    user: "root"

  # 2. RPC Gateway (Nginx - DDoS Protection)
  rpc-gateway:
    image: nginx:latest
    restart: unless-stopped
    depends_on:
      - l2-geth
    ports:
      - "8545:80"  # Public RPC endpoint (proxied to l2-geth)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    logging: *default-logging

  # 3. Execution Client (op-geth)
  l2-geth:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:${OP_GETH_TAG:-latest}
    restart: unless-stopped
    depends_on:
      l2-geth-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:8546:8546"  # WebSocket (localhost only)
      - "127.0.0.1:6060:6060"  # Metrics (localhost only)
      # Note: 8545 HTTP RPC is NOT exposed directly - access via rpc-gateway only
    volumes:
      - ./data:/db
      - ./secrets:/secrets
    logging: *default-logging
    command: >
      --datadir=/db
      --http --http.addr=0.0.0.0 --http.port=8545 --http.corsdomain="*" --http.vhosts="*" --http.api=web3,debug,eth,txpool,net,engine,miner,admin,personal
      --ws --ws.addr=0.0.0.0 --ws.port=8546 --ws.api=debug,eth,txpool,net,engine --ws.origins="*"
      --authrpc.addr=0.0.0.0 --authrpc.port=8551 --authrpc.vhosts="*" --authrpc.jwtsecret=/secrets/jwt.txt
      --syncmode=full --gcmode=archive --nodiscover --maxpeers=0
      --networkid=${L2_CHAIN_ID:-12345678}
      --rollup.disabletxpoolgossip=true
      --metrics --metrics.addr=0.0.0.0 --metrics.port=6060

  # 4. Consensus Client (op-node)
  l2-node:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:${OP_NODE_TAG:-latest}
    restart: unless-stopped
    depends_on:
      - l2-geth
    ports:
      - "8547:8547"  # Node RPC
      - "9003:9003"  # P2P
      - "7300:7300"  # Metrics
    volumes:
      - ./config:/config
      - ./secrets:/secrets
    environment:
      - L1_RPC_URL=${L1_RPC_URL}
      - OP_NODE_P2P_SEQUENCER_KEY=${SEQUENCER_PRIVATE_KEY}
    logging: *default-logging
    command: >
      op-node
      --l1=${L1_RPC_URL}
      --l1.rpckind=alchemy
      --l1.beacon=https://ethereum-sepolia-beacon-api.publicnode.com
      --l2=http://l2-geth:8551
      --l2.jwt-secret=/secrets/jwt.txt
      --rollup.config=/config/rollup.json
      --rpc.addr=0.0.0.0
      --rpc.port=8547
      --rpc.enable-admin
      --sequencer.enabled
      --sequencer.l1-confs=3
      --sequencer.max-safe-lag=1000
      --verifier.l1-confs=3
      --p2p.disable=false
      --p2p.listen.tcp=9003
      --p2p.listen.udp=9003
      --p2p.advertise.tcp=9003
      --p2p.advertise.udp=9003
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7300
      --log.level=info
      --log.format=json

  # 5. Batcher (submits transaction batches to Celestia/L1)
  l2-batcher:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-batcher:${OP_BATCHER_TAG:-latest}
    restart: unless-stopped
    depends_on:
      - l2-node
    ports:
      - "7301:7301"  # Metrics
    volumes:
      - ./secrets:/secrets
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - L1_RPC_URL=${L1_RPC_URL}
      - DA_SERVER_URL=${DA_SERVER_URL}
      - OP_BATCHER_PRIVATE_KEY=${BATCHER_PRIVATE_KEY}
    logging: *default-logging
    command: >
      op-batcher
      --l1-eth-rpc=${L1_RPC_URL}
      --l2-eth-rpc=http://l2-geth:8545
      --rollup-rpc=http://l2-node:8547
      --poll-interval=2s
      --sub-safety-margin=3
      --num-confirmations=2
      --safe-abort-nonce-too-low-count=5
      --resubmission-timeout=120s
      --max-channel-duration=15
      --compression-algo=brotli
      --altda.enabled=true
      --altda.da-service=true
      --altda.da-server=${DA_SERVER_URL}
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7301
      --log.level=info
      --log.format=json

  # 6. Proposer (submits L2 state roots to L1 via DisputeGameFactory)
  # Using local build instead of official image for protocol version compatibility
  l2-proposer:
    image: alpine:latest
    restart: unless-stopped
    depends_on:
      - l2-node
    ports:
      - "7302:7302"  # Metrics
    volumes:
      - ./secrets:/secrets
      - ./bin/op-proposer:/usr/local/bin/op-proposer
    environment:
      - L1_RPC_URL=${L1_RPC_URL}
      - DISPUTE_GAME_FACTORY_ADDRESS=${DISPUTE_GAME_FACTORY_ADDRESS}
    logging: *default-logging
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "apk add --no-cache ca-certificates &&
      /usr/local/bin/op-proposer
      --poll-interval=12s
      --rpc.port=8560
      --rollup-rpc=http://l2-node:8547
      --l1-eth-rpc=${L1_RPC_URL}
      --private-key=$(cat /secrets/proposer.key)
      --game-type=0
      --game-factory-address=${DISPUTE_GAME_FACTORY_ADDRESS}
      --proposal-interval=120s
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7302
      --log.level=info"

  # 7. Celestia Light Node (Alt-DA Layer)
  celestia-light:
    image: ghcr.io/celestiaorg/celestia-node:latest
    restart: unless-stopped
    ports:
      - "26658:26658"  # RPC
    volumes:
      - ./data/celestia:/home/celestia
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "celestia light init --p2p.network mocha || true &&
      exec celestia light start
      --p2p.network mocha"

  # 8. Gas Price Updater Bot (maintains economic safety)
  gas-oracle:
    build:
      context: ./gas-bot
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - l2-node
    ports:
      - "2112:2112"  # Prometheus metrics
    environment:
      - L1_RPC_URL=${L1_RPC_URL}
      - OPERATOR_PRIVATE_KEY=${OPERATOR_PRIVATE_KEY}
      - SYSTEM_CONFIG_ADDRESS=${SYSTEM_CONFIG_ADDRESS}
      - UPDATE_THRESHOLD=${UPDATE_THRESHOLD:-5.0}
      - DA_FACTOR=${DA_FACTOR:-0.1}
      - SAFETY_MARGIN=${SAFETY_MARGIN:-1.1}
      - CHECK_INTERVAL=${CHECK_INTERVAL:-30}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
    logging: *default-logging

  # 9. Explorer Database (PostgreSQL for Blockscout)
  explorer-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=blockscout
    volumes:
      - ./data/explorer-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 10. Explorer Cache (Redis for Blockscout)
  explorer-redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 11. BEGAScan (Blockscout Explorer)
  begascan:
    image: blockscout/blockscout:latest
    restart: unless-stopped
    depends_on:
      explorer-db:
        condition: service_healthy
      explorer-redis:
        condition: service_healthy
      l2-geth:
        condition: service_started
    ports:
      - "4000:4000"
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://postgres:password@explorer-db:5432/blockscout?ssl=false

      # Chain Configuration
      - ETHEREUM_JSONRPC_VARIANT=geth
      - ETHEREUM_JSONRPC_HTTP_URL=http://l2-geth:8545
      - ETHEREUM_JSONRPC_WS_URL=ws://l2-geth:8546
      - ETHEREUM_JSONRPC_TRACE_URL=http://l2-geth:8545

      # Network Branding
      - COIN=BEGA
      - COIN_NAME=BEGA
      - NETWORK=BEGA L2 Mainnet
      - SUBNETWORK=BEGA L2
      - CHAIN_ID=12345678

      # Explorer Configuration
      - PORT=4000
      - ECTO_USE_SSL=false
      - MIX_ENV=dev
      - SECRET_KEY_BASE=ExM1WVtDhE1IAnpXT2fEGvAArGyG73svJkOhnL8cPWig5AJvBQVFJ+/T6zAGIoRG4F0Qi3qMoEPTdPOvkDRYRA==
      - BLOCKSCOUT_PROTOCOL=http
      - BLOCKSCOUT_HOST=localhost

      # Redis Configuration
      - REDIS_URL=redis://explorer-redis:6379

      # Feature Flags
      - SHOW_PRICE_CHART=false
      - DISPLAY_TOKEN_ICONS=false
      - SHOW_ADDRESS_MARKETCAP_PERCENTAGE=false
      - INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER=true

      # Logo and Branding (Optional - can be customized later)
      - LOGO=/images/blockscout_logo.svg
      - LOGO_FOOTER=/images/blockscout_logo.svg

  # 12. BEGAScan Frontend (Blockscout UI)
  begascan-frontend:
    image: ghcr.io/blockscout/frontend:latest
    restart: unless-stopped
    depends_on:
      - begascan
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_APP_HOST=localhost
      - NEXT_PUBLIC_APP_PORT=3000
      - NEXT_PUBLIC_APP_PROTOCOL=http
      - NEXT_PUBLIC_API_HOST=begascan
      - NEXT_PUBLIC_API_PORT=4000
      - NEXT_PUBLIC_API_PROTOCOL=http
      - NEXT_PUBLIC_STATS_API_HOST=http://begascan:4000
      - NEXT_PUBLIC_NETWORK_NAME=BEGA L2 Mainnet
      - NEXT_PUBLIC_NETWORK_SHORT_NAME=BEGA L2
      - NEXT_PUBLIC_NETWORK_ID=12345678
      - NEXT_PUBLIC_NETWORK_CURRENCY_NAME=BEGA
      - NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL=BEGA
      - NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS=18
      - NEXT_PUBLIC_API_SPEC_URL=https://raw.githubusercontent.com/blockscout/blockscout-api-v2-swagger/main/swagger.yaml

  # 13. Prometheus (Metrics Collection)
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/alert_rules.yml:/etc/prometheus/alert_rules.yml
      - ./data/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'

  # 14. Alertmanager (Alert Management)
  alertmanager:
    image: prom/alertmanager:latest
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - ./data/alertmanager:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'

  # 15. Grafana (Metrics Visualization)
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/etc/grafana/dashboards
      - ./data/grafana:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001

networks:
  default:
    name: bega-l2-network
